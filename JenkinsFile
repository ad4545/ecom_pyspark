pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: node
    image: adarsh7r/ecom-pytest:latest
    command:
    - cat
    tty: true
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: kaniko-secret
      mountPath: /kaniko/.docker
  volumes:
  - name: kaniko-secret
    secret:
      secretName: docker-cred
"""
        }
    }

    environment {
        DOCKER_IMAGE = "adarsh7r/spark-app:${BUILD_NUMBER}"
    }

    stages {
        stage('Pyspark Test') {
            steps {
                container('node') {
                    sh 'pytest'
                }
            }
        }

        stage('Build and Push with Kaniko') {
            steps {
                container('kaniko') {
                    sh '''
                        set -eux
                        whoami
                        id

                        # Download JARs into build context
                        curl -O https://seven-robotics.s3.ap-south-1.amazonaws.com/spark-essentials/aws-java-sdk-bundle-1.11.271.jar
                        curl -O https://seven-robotics.s3.ap-south-1.amazonaws.com/spark-essentials/bundle-2.0.0-preview-7.jar
                        curl -O https://seven-robotics.s3.ap-south-1.amazonaws.com/spark-essentials/bundle-2.32.7.jar
                        curl -O https://seven-robotics.s3.ap-south-1.amazonaws.com/spark-essentials/hadoop-aws-3.4.1.jar
                        curl -O https://seven-robotics.s3.ap-south-1.amazonaws.com/spark-essentials/snowflake-jdbc-3.13.21.jar
                        curl -O https://seven-robotics.s3.ap-south-1.amazonaws.com/spark-essentials/spark-snowflake_2.13-3.1.1.jar

                        # Kaniko build & push
                        /kaniko/executor \
                          --context `pwd` \
                          --dockerfile `pwd`/Dockerfile \
                          --destination=$DOCKER_IMAGE \
                          --cache=true \
                          --cleanup
                    '''
                }
            }
        }
    }
}
