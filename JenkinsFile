pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: node
    image: adarsh7r/ecom-pytest:latest
    command:
      - cat
    tty: true
    volumeMounts:
      - name: jar-vol
        mountPath: /home/jenkins/agent/artifacts

  - name: docker
    image: docker:27-cli
    command:
      - cat
    tty: true
    env:
      - name: DOCKER_HOST
        value: "tcp://host.docker.internal:2375"
    volumeMounts:
      - name: jar-vol
        mountPath: /home/jenkins/agent/artifacts
  volumes:
    - name: jar-vol
      persistentVolumeClaim:
        claimName: jar-pvc        
"""
    }
  }

  stages {
    stage('PySpark Test') {
      steps {
        container('node') {
          sh 'pytest'
        }
      }
    }

    stage('Prepare JARs (fast, from PVC)') {
      steps {
        container('node') {
          sh '''
            echo "Listing mounted artifacts (PVC):"
            ls -lh /home/jenkins/agent/artifacts || true

            echo "Ensure workspace artifacts dir exists"
            mkdir -p "$WORKSPACE/artifacts"

            echo "Copy JARs from PVC mount into workspace (fast local copy)"
            cp -a /home/jenkins/agent/artifacts/. "$WORKSPACE/artifacts/" || true

            echo "Verify workspace artifacts:"
            ls -lh "$WORKSPACE/artifacts"
          '''
        }
      }
    }

    stage('Docker Build') {
      steps {
        container('docker') {
          sh '''
            echo "Docker client version:"
            docker version || true

            echo "Building image (build context contains artifacts/):"
            docker build -t spark-app:${BUILD_NUMBER} .

            echo "Image built - list images"
            docker images | head -n 20
          '''
        }
      }
    }

    stage('Docker Push') {
      steps {
        container('docker') {
          withCredentials([usernamePassword(credentialsId: 'docker-cred', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
            sh '''
              echo "Logging in to Docker Hub..."
              echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

              IMAGE_NAME="${DOCKER_USER}/spark-app:latest"

              echo "Tagging image as $IMAGE_NAME"
              docker tag spark-app:latest $IMAGE_NAME

              echo "Pushing image to Docker Hub..."
              docker push $IMAGE_NAME

              echo "Successfully pushed $IMAGE_NAME"
            '''
          }
        }
      }
    }
  }
}
