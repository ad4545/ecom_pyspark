pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: node
    image: adarsh7r/ecom-pytest:latest
    command:
    - cat
    tty: true
"""
        }
    }
    stages {
        stage('Pyspark Test') {
            steps {
                container('node') {
                    sh 'pytest'
                }
            }
        }
        stage('Build and Push Image') {
            steps {
                container('node') {
                    sh '''
                            # Quick fix: Download Docker CLI binary directly
                            curl -fsSL "https://download.docker.com/linux/static/stable/x86_64/docker-25.0.3.tgz" | \
                            tar -xzv --strip-components=1 -C /usr/local/bin docker/docker
                            
                            chmod +x /usr/local/bin/docker
                            docker --version
                            docker info
                        '''
                }
            }
        }
    }
}